---
# TUN-001: IPIP tunnel interface
# Topology: 2-node symmetric
#   r1: creates IPIP tunnel sourced from rv_underlay_ip, remote=r2, overlay IP, pings r2
#   r2: creates IPIP tunnel sourced from rv_underlay_ip, remote=r1, overlay IP, pings r1
- block:
    - name: TUN-001 - Set up eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      tags: [TUN-001, interfaces, tunnel]

    - import_tasks: ../_helpers/wait_for_eth1_underlay.yml
      vars:
        _wait_test_id: "TUN-001"
      tags: [TUN-001, interfaces, tunnel]

    - name: TUN-001 - Configure IPIP tunnel
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces tunnel {{ rv_tunnel_name }} encapsulation ipip"
          - "set interfaces tunnel {{ rv_tunnel_name }} source-address '{{ rv_underlay_ip }}'"
          - "set interfaces tunnel {{ rv_tunnel_name }} remote '{{ hostvars[rv_peer].rv_underlay_ip }}'"
          - "set interfaces tunnel {{ rv_tunnel_name }} address '{{ rv_tunnel_overlay_ip }}/24'"
      tags: [TUN-001, interfaces, tunnel]

    - name: TUN-001 - Verify tunnel (show)
      vyos.vyos.vyos_command:
        commands:
          - "show interfaces tunnel {{ rv_tunnel_name }}"
      register: tun_show
      tags: [TUN-001, interfaces, tunnel]

    - name: TUN-001 - Verify tunnel config (encapsulation and source)
      vyos.vyos.vyos_command:
        commands:
          - "show configuration commands | grep 'interfaces tunnel {{ rv_tunnel_name }}'"
      register: tun_config
      tags: [TUN-001, interfaces, tunnel]

    - name: TUN-001 - Assert tunnel present with overlay IP, encapsulation and source
      ansible.builtin.assert:
        that:
          - tun_show.stdout is defined
          - tun_show.stdout | length > 0
          - "rv_tunnel_name in tun_show.stdout[0]"
          - "rv_tunnel_overlay_ip in tun_show.stdout[0]"
          - tun_config.stdout is defined
          - "'ipip' in tun_config.stdout[0]"
          - "'source-address' in tun_config.stdout[0]"
        fail_msg: "TUN-001: Tunnel config incorrect. Expected overlay {{ rv_tunnel_overlay_ip }}, encapsulation ipip. show: {{ tun_show.stdout[0] | default('(no output)') | truncate(200) }}"
      tags: [TUN-001, interfaces, tunnel]

    - name: TUN-001 - Verify underlay reachable before overlay ping
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ hostvars[rv_peer].rv_underlay_ip }} count 3 deadline 5"
      register: _tun_underlay_check
      until: "', 0% packet loss' in _tun_underlay_check.stdout[0]"
      retries: 6
      delay: 3
      tags: [TUN-001, interfaces, tunnel]

    - import_tasks: ../_helpers/ping_peer.yml
      vars:
        _ping_target: "{{ hostvars[rv_peer].rv_tunnel_overlay_ip }}"
        _ping_test_id: "TUN-001"
      tags: [TUN-001, interfaces, tunnel]

  rescue:
    - name: TUN-001 - Record test failure
      ansible.builtin.set_fact:
        _test_failed: true

  always:
    - name: TUN-001 - Cleanup tunnel
      vyos.vyos.vyos_config:
        lines: ["delete interfaces tunnel {{ rv_tunnel_name }}"]
      ignore_errors: true
      tags: [TUN-001, interfaces, tunnel, cleanup]

    - name: TUN-001 - Remove eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "delete interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      ignore_errors: true
      tags: [TUN-001, interfaces, tunnel, cleanup]
  when: inventory_hostname in groups['pair_1']
