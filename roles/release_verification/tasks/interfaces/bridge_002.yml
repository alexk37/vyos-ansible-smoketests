---
# BRIDGE-002: VLAN-aware bridge and connectivity
# Topology: 2-node (pair_1)
#   r1, r2: each creates VLAN-aware br0 with eth1 as access port (native-vlan 10),
#           IP on br0 vif 10. Ping peer to verify L2 connectivity across bridge.
#
# Unit tests (test_bridge_vlan_filter) cover: config/sysfs only, single-node.
# This test adds: real L2 connectivity between two nodes over VLAN-aware bridge.
#
- block:
    - name: BRIDGE-002 - Pre-clean bridge
      vyos.vyos.vyos_config:
        lines:
          - "delete interfaces bridge {{ rv_bridge_name }}"
      ignore_errors: true
      tags: [BRIDGE-002, interfaces, bridge, cleanup]

    - name: BRIDGE-002 - Configure VLAN-aware bridge (enable-vlan, member, vif)
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces bridge {{ rv_bridge_name }} enable-vlan"
          - "set interfaces bridge {{ rv_bridge_name }} member interface {{ rv_eth_test_interfaces[0] }} native-vlan {{ rv_bridge_vlan_id }}"
          - "set interfaces bridge {{ rv_bridge_name }} member interface {{ rv_eth_test_interfaces[0] }} allowed-vlan {{ rv_bridge_vlan_id }}"
          - "set interfaces bridge {{ rv_bridge_name }} vif {{ rv_bridge_vlan_id }} address '{{ rv_bridge_vlan_ip }}/24'"
      tags: [BRIDGE-002, interfaces, bridge]

    - name: BRIDGE-002 - Verify bridge VLAN filter (show bridge vlan)
      vyos.vyos.vyos_command:
        commands:
          - "show bridge vlan"
      register: bridge_vlan
      tags: [BRIDGE-002, interfaces, bridge]

    - name: BRIDGE-002 - Assert VLAN-aware bridge config present
      ansible.builtin.assert:
        that:
          - bridge_vlan.stdout is defined
          - bridge_vlan.stdout | length > 0
          - "rv_bridge_vlan_id in bridge_vlan.stdout[0]"
          - "rv_bridge_name in bridge_vlan.stdout[0] or rv_eth_test_interfaces[0] in bridge_vlan.stdout[0]"
        fail_msg: "BRIDGE-002: VLAN-aware bridge config not found. show bridge vlan: {{ bridge_vlan.stdout[0] | default('') | truncate(300) }}"
      tags: [BRIDGE-002, interfaces, bridge]

    - import_tasks: ../_helpers/ping_peer.yml
      vars:
        _ping_target: "10.50.0.{{ rv_host_octet[rv_peer] }}"
        _ping_test_id: "BRIDGE-002"
      tags: [BRIDGE-002, interfaces, bridge]

  rescue:
    - name: BRIDGE-002 - Record test failure
      ansible.builtin.set_fact:
        _test_failed: true

  always:
    - name: BRIDGE-002 - Cleanup bridge
      vyos.vyos.vyos_config:
        lines: ["delete interfaces bridge {{ rv_bridge_name }}"]
      ignore_errors: true
      tags: [BRIDGE-002, interfaces, bridge, cleanup]
  when: inventory_hostname in groups['pair_1']
