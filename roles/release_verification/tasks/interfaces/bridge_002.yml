---
# BRIDGE-002: Bridge firewall — configuration applies (config-only)
# Topology: 1-node
#   r1: creates br0, adds bridge firewall forward filter rule, verifies in show output
#
# In current VyOS, bridge firewall is global under "set firewall bridge",
# not per-interface. We create a bridge, add bridge firewall rules, and verify
# they appear in "show firewall bridge".
#
# NOTE — config-only, no traffic test:
#   This test verifies the bridge firewall config can be committed on live hardware.
#   Actual enforcement (FORWARD, INPUT, OUTPUT hooks blocking/accepting real frames)
#   is covered by FW-BRIDGE-001 (firewall category), which uses a 3-node topology:
#   r1 eth3 → r2 br0 (eth3+eth2) → r3 eth1, with real ICMP traffic crossing the bridge.
- block:
    - name: BRIDGE-002 - Configure bridge
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces bridge {{ rv_bridge_name }} address '{{ rv_ipv4_prefix }}.2/24'"
          - "set interfaces bridge {{ rv_bridge_name }} member interface '{{ rv_eth_test_interfaces[1] }}'"
      tags: [BRIDGE-002, interfaces, bridge]

    - name: BRIDGE-002 - Configure bridge firewall forward filter
      vyos.vyos.vyos_config:
        lines:
          - "set firewall bridge forward filter default-action 'accept'"
          - "set firewall bridge forward filter rule 1 action 'accept'"
          - "set firewall bridge forward filter rule 1 protocol 'icmp'"
      tags: [BRIDGE-002, interfaces, bridge]

    - name: BRIDGE-002 - Verify bridge firewall (show)
      vyos.vyos.vyos_command:
        commands:
          - "show firewall bridge"
      register: fw_show
      tags: [BRIDGE-002, interfaces, bridge]

    - name: BRIDGE-002 - Assert bridge firewall rules present
      ansible.builtin.assert:
        that:
          - fw_show.stdout is defined
          - fw_show.stdout | length > 0
          - "'forward' in fw_show.stdout[0]"
          - "'icmp' in fw_show.stdout[0]"
          - "'accept' in fw_show.stdout[0]"
        fail_msg: "BRIDGE-002: Bridge firewall rules not found. Expected forward filter with rule 1 icmp accept. Got: {{ fw_show.stdout[0] | default('(no output)') | truncate(300) }}"
      tags: [BRIDGE-002, interfaces, bridge]

  rescue:
    - name: BRIDGE-002 - Record test failure
      ansible.builtin.set_fact:
        _test_failed: true

  always:
    - name: BRIDGE-002 - Cleanup bridge firewall and bridge
      vyos.vyos.vyos_config:
        lines:
          - "delete firewall bridge forward filter"
          - "delete interfaces bridge {{ rv_bridge_name }}"
      ignore_errors: true
      tags: [BRIDGE-002, interfaces, bridge, cleanup]
  when: inventory_hostname == 'r1'
