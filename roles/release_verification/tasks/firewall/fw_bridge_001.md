# FW-BRIDGE-001: Bridge firewall — input, output, forward, prerouting hooks

Topology: 3-node asymmetric
- r1: left host — eth3 address 10.40.0.1/24 (direct cable to r2 eth3)
- r2: bridge — br0 with eth3+eth2 as members, br0 address 10.40.0.2/24
- r3: right host — eth1 address 10.40.0.3/24 (via shared switch on r2 eth2)

r1 eth3 is directly cabled to r2 eth3 (bypasses the shared lab switch). r2 eth2 connects
via the shared switch to r3 eth1. The two bridge ports are on physically isolated segments,
so bridging eth3+eth2 does not create an L2 loop.

Traffic paths:
- FORWARD: r1 → r2(bridge, eth3→eth2) → r3   (frame crosses bridge, FORWARD chain fires on r2)
- INPUT:   r1 → r2(br0 IP)                    (frame destined to bridge itself, INPUT chain fires)
- OUTPUT:  r2(br0) → r1                        (frame from bridge, OUTPUT chain fires)
- PREROUTING: all frames entering bridge        (fires before forward/input decision, config-only)

## Phase 1: Underlay setup

### Configure (r1)

```
set interfaces ethernet eth3 address '10.40.0.1/24'
```

### Configure (r2)

```
set interfaces bridge br0 member interface eth3
set interfaces bridge br0 member interface eth2
set interfaces bridge br0 address '10.40.0.2/24'
```

### Configure (r3)

```
set interfaces ethernet eth1 address '10.40.0.3/24'
```

## Phase 2: Baseline

### Verify (r1)

```
ping 10.40.0.3 count 3 deadline 10
```

### Assert

- ', 0% packet loss' in output

## Phase A: Bridge FORWARD filter

FORWARD hook fires when a frame enters eth3 (r1 side) and exits eth2 (r3 side).

### Configure (r2)

```
set firewall bridge forward filter rule 100 action 'drop'
set firewall bridge forward filter rule 100 source address '10.40.0.1'
```

### Verify (r1)

```
ping 10.40.0.3 count 3 deadline 5
```

### Assert

- '100% packet loss' in output

### Configure (r2)

```
set firewall bridge forward filter rule 50 action 'accept'
set firewall bridge forward filter rule 50 source address '10.40.0.1'
```

### Verify (r1)

```
ping 10.40.0.3 count 3 deadline 10
```

### Assert

- ', 0% packet loss' in output  (rule 50 accept wins over rule 100 drop)

### Cleanup (between phases, r2)

```
delete firewall bridge forward filter rule 50
delete firewall bridge forward filter rule 100
```

## Phase B: Bridge INPUT filter

INPUT hook fires for frames destined to the bridge device itself (br0 IP).
r1 pings br0 IP (10.40.0.2); frame enters eth3 with dst MAC = br0 MAC → INPUT chain.

### Configure (r2)

```
set firewall bridge input filter rule 100 action 'drop'
set firewall bridge input filter rule 100 source address '10.40.0.1'
```

### Verify (r1)

```
ping 10.40.0.2 count 3 deadline 5
```

### Assert

- '100% packet loss' in output

### Configure (r2)

```
set firewall bridge input filter rule 50 action 'accept'
set firewall bridge input filter rule 50 source address '10.40.0.1'
```

### Verify (r1)

```
ping 10.40.0.2 count 3 deadline 10
```

### Assert

- ', 0% packet loss' in output  (rule 50 accept wins over rule 100 drop)

### Cleanup (between phases, r2)

```
delete firewall bridge input filter rule 50
delete firewall bridge input filter rule 100
```

## Phase C: Bridge OUTPUT filter

OUTPUT hook fires for frames generated by the bridge device itself (br0).
r2 pings r1 from br0 (10.40.0.2 → 10.40.0.1) → OUTPUT chain fires on r2.

### Configure (r2)

```
set firewall bridge output filter rule 100 action 'drop'
set firewall bridge output filter rule 100 destination address '10.40.0.1'
```

### Verify (r2)

```
ping 10.40.0.1 count 3 deadline 5
```

### Assert

- '100% packet loss' in output

### Configure (r2)

```
set firewall bridge output filter rule 50 action 'accept'
set firewall bridge output filter rule 50 destination address '10.40.0.1'
```

### Verify (r2)

```
ping 10.40.0.1 count 3 deadline 10
```

### Assert

- ', 0% packet loss' in output  (rule 50 accept wins over rule 100 drop)

### Cleanup (between phases, r2)

```
delete firewall bridge output filter rule 50
delete firewall bridge output filter rule 100
```

## Phase D: Bridge PREROUTING filter (config verification)

PREROUTING fires on all incoming frames before the forward/input decision.
notrack behavior requires conntrack inspection — config verification only.

### Configure (r2)

```
set firewall bridge prerouting filter rule 10 action 'accept'
set firewall bridge prerouting filter rule 10 ethernet-type 'arp'
```

### Verify (r2)

```
show configuration commands | grep 'firewall bridge'
```

### Assert

- 'bridge forward filter' in output
- 'bridge input filter' in output
- 'bridge output filter' in output
- 'bridge prerouting filter' in output

## Cleanup

```
# r2
delete firewall bridge forward filter rule 50
delete firewall bridge forward filter rule 100
delete firewall bridge input filter rule 50
delete firewall bridge input filter rule 100
delete firewall bridge output filter rule 50
delete firewall bridge output filter rule 100
delete firewall bridge prerouting filter rule 10
delete interfaces bridge br0

# r1
delete interfaces ethernet eth3 address '10.40.0.1/24'

# r3
delete interfaces ethernet eth1 address '10.40.0.3/24'
```
