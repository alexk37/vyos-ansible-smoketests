---
# FW-GROUP-002: Firewall port-group and interface-group
# Topology: 2-node symmetric
#   r1: creates port/interface groups, applies in firewall rule, pings r2 underlay
#   r2: creates port/interface groups, applies in firewall rule, pings r1 underlay
- block:
    - name: FW-GROUP-002 - Set up eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      tags: [FW-GROUP-002, firewall, groups]

    - name: FW-GROUP-002 - Configure port-group and interface-group
      vyos.vyos.vyos_config:
        lines:
          - "set firewall group port-group {{ rv_fw_group_port }} port '22'"
          - "set firewall group port-group {{ rv_fw_group_port }} port '80'"
          - "set firewall group port-group {{ rv_fw_group_port }} port '443'"
          - "set firewall group interface-group {{ rv_fw_group_interface }} interface '{{ rv_eth_test_interfaces[0] }}'"
      tags: [FW-GROUP-002, firewall, groups]

    - name: FW-GROUP-002 - Apply groups in firewall rule
      vyos.vyos.vyos_config:
        lines:
          - "set firewall ipv4 input filter rule 200 action 'accept'"
          - "set firewall ipv4 input filter rule 200 protocol 'tcp'"
          - "set firewall ipv4 input filter rule 200 destination group port-group '{{ rv_fw_group_port }}'"
      tags: [FW-GROUP-002, firewall, groups]

    - name: FW-GROUP-002 - Verify (show firewall group)
      vyos.vyos.vyos_command:
        commands:
          - "show firewall group"
      register: fw_group2_show
      tags: [FW-GROUP-002, firewall, groups]

    - name: FW-GROUP-002 - Assert port-group and interface-group present with members
      ansible.builtin.assert:
        that:
          - fw_group2_show.stdout is defined
          - fw_group2_show.stdout | length > 0
          - "rv_fw_group_port in fw_group2_show.stdout[0]"
          - "rv_fw_group_interface in fw_group2_show.stdout[0]"
          - "'22' in fw_group2_show.stdout[0]"
          - "'443' in fw_group2_show.stdout[0]"
          - "rv_eth_test_interfaces[0] in fw_group2_show.stdout[0]"
        fail_msg: "FW-GROUP-002: Groups or members not found. Expected {{ rv_fw_group_port }} with ports 22/443, {{ rv_fw_group_interface }} with {{ rv_eth_test_interfaces[0] }}. Got: {{ fw_group2_show.stdout[0] | default('(no output)') | truncate(300) }}"
      tags: [FW-GROUP-002, firewall, groups]

    - import_tasks: ../_helpers/ping_peer.yml
      vars:
        _ping_target: "{{ hostvars[rv_peer].rv_underlay_ip }}"
        _ping_test_id: "FW-GROUP-002"
        _ping_count: 2
      tags: [FW-GROUP-002, firewall, groups]

  always:
    - name: FW-GROUP-002 - Cleanup firewall rule
      vyos.vyos.vyos_config:
        lines:
          - "delete firewall ipv4 input filter rule 200"
      ignore_errors: true
      tags: [FW-GROUP-002, firewall, groups, cleanup]

    - name: FW-GROUP-002 - Cleanup firewall groups
      vyos.vyos.vyos_config:
        lines:
          - "delete firewall group port-group {{ rv_fw_group_port }}"
          - "delete firewall group interface-group {{ rv_fw_group_interface }}"
      ignore_errors: true
      tags: [FW-GROUP-002, firewall, groups, cleanup]

    - name: FW-GROUP-002 - Remove eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "delete interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      ignore_errors: true
      tags: [FW-GROUP-002, firewall, groups, cleanup]
  when: inventory_hostname in groups['pair_1']
