---
# FW-IPV4-001: IPv4 input filter rules — real traffic enforcement
# Topology: 2-node symmetric
#   r1: configures drop + accept rules on input filter, verifies ICMP is blocked then accepted
#   r2: same
#
# VyOS unit tests (smoketest/scripts/cli/test_firewall.py) already cover:
#   - CLI → nftables rule translation for all action types (accept, drop, return, queue, jump)
#   - Source/dest address, port, protocol, TCP flags, mark, packet-type matching
#   - Chain creation (VYOS_INPUT_filter) and hook binding at priority filter
#   - State matching, conntrack, synproxy, dynamic address groups
#
# This test adds what unit tests cannot cover:
#   - Real ICMP packets are actually dropped by a drop rule on live routers
#   - Rule ordering is enforced on live traffic: lower-numbered accept rule (50) beats
#     higher-numbered drop rule (100) — proven by traffic, not just nftables config
- block:
    - name: FW-IPV4-001 - Pre-clean config paths
      vyos.vyos.vyos_config:
        lines:
          - "delete firewall ipv4 input filter"
          - "delete interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      ignore_errors: true
      tags: [FW-IPV4-001, firewall, ipv4, cleanup]

    - name: FW-IPV4-001 - Set up eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      tags: [FW-IPV4-001, firewall, ipv4]

    - import_tasks: ../_helpers/wait_for_eth1_underlay.yml
      vars:
        _wait_test_id: "FW-IPV4-001"
      tags: [FW-IPV4-001, firewall, ipv4]

    - name: "FW-IPV4-001 - Baseline: verify connectivity before firewall rules"
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ hostvars[rv_peer].rv_underlay_ip }} count 3 deadline 5"
      register: _fw_ipv4_001_baseline
      until: "', 0% packet loss' in _fw_ipv4_001_baseline.stdout[0]"
      retries: 6
      delay: 3
      tags: [FW-IPV4-001, firewall, ipv4]

    - name: FW-IPV4-001 - Add drop rule for ICMP from peer
      vyos.vyos.vyos_config:
        lines:
          - "set firewall ipv4 input filter rule 100 action 'drop'"
          - "set firewall ipv4 input filter rule 100 protocol 'icmp'"
          - "set firewall ipv4 input filter rule 100 source address '{{ hostvars[rv_peer].rv_underlay_ip }}'"
      tags: [FW-IPV4-001, firewall, ipv4]

    - name: FW-IPV4-001 - Verify ICMP is blocked by drop rule
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ hostvars[rv_peer].rv_underlay_ip }} count 3 deadline 5"
      register: fw_ipv4_block_result
      tags: [FW-IPV4-001, firewall, ipv4]

    - name: FW-IPV4-001 - Assert ICMP is blocked
      ansible.builtin.assert:
        that:
          - fw_ipv4_block_result.stdout is defined
          - fw_ipv4_block_result.stdout | length > 0
          - "'100% packet loss' in fw_ipv4_block_result.stdout[0]"
        fail_msg: >-
          FW-IPV4-001: Expected ICMP to be dropped but ping succeeded.
          Output: {{ fw_ipv4_block_result.stdout[0] | default('(no output)') | truncate(300) }}
      tags: [FW-IPV4-001, firewall, ipv4]

    - name: FW-IPV4-001 - Add accept rule with lower number (rule 50 wins over rule 100)
      vyos.vyos.vyos_config:
        lines:
          - "set firewall ipv4 input filter rule 50 action 'accept'"
          - "set firewall ipv4 input filter rule 50 protocol 'icmp'"
          - "set firewall ipv4 input filter rule 50 source address '{{ hostvars[rv_peer].rv_underlay_ip }}'"
      tags: [FW-IPV4-001, firewall, ipv4]

    - name: FW-IPV4-001 - Verify both rules in config
      vyos.vyos.vyos_command:
        commands:
          - "show configuration commands | grep 'firewall ipv4 input filter rule'"
      register: fw_ipv4_rules
      tags: [FW-IPV4-001, firewall, ipv4]

    - name: FW-IPV4-001 - Assert both rules present
      ansible.builtin.assert:
        that:
          - fw_ipv4_rules.stdout is defined
          - fw_ipv4_rules.stdout | length > 0
          - "'rule 50' in fw_ipv4_rules.stdout[0]"
          - "'rule 100' in fw_ipv4_rules.stdout[0]"
          - "'accept' in fw_ipv4_rules.stdout[0]"
          - "'drop' in fw_ipv4_rules.stdout[0]"
        fail_msg: >-
          FW-IPV4-001: Expected rules 50 (accept) and 100 (drop) in config.
          Got: {{ fw_ipv4_rules.stdout[0] | default('(no output)') | truncate(300) }}
      tags: [FW-IPV4-001, firewall, ipv4]

    - import_tasks: ../_helpers/ping_peer.yml
      vars:
        _ping_target: "{{ hostvars[rv_peer].rv_underlay_ip }}"
        _ping_test_id: "FW-IPV4-001"
      tags: [FW-IPV4-001, firewall, ipv4]

  rescue:
    - name: FW-IPV4-001 - Record test failure
      ansible.builtin.set_fact:
        _test_failed: true

  always:
    - name: FW-IPV4-001 - Cleanup firewall rules
      vyos.vyos.vyos_config:
        lines:
          - "delete firewall ipv4 input filter rule 50"
          - "delete firewall ipv4 input filter rule 100"
      ignore_errors: true
      tags: [FW-IPV4-001, firewall, ipv4, cleanup]

    - name: FW-IPV4-001 - Remove eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "delete interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      ignore_errors: true
      tags: [FW-IPV4-001, firewall, ipv4, cleanup]
  when: inventory_hostname in groups['pair_1']
