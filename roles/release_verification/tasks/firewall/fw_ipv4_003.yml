---
# FW-IPV4-003: IPv4 output filter and prerouting raw
# Topology: 2-node symmetric
#   r1: configures output filter + prerouting raw rules, verifies live enforcement
#   r2: same
#
# VyOS unit tests (smoketest/scripts/cli/test_firewall.py) already cover:
#   - CLI → VYOS_OUTPUT_filter chain (type filter hook output priority filter)
#   - CLI → VYOS_PREROUTING_raw chain (type filter hook prerouting priority raw)
#   - action notrack on prerouting raw: nftables 'notrack' keyword inserted
#   - output filter: outbound-interface match, connection-mark match → nftables translation
#
# This test adds what unit tests cannot cover:
#   - Output filter actually blocks locally-originated ICMP on live routers
#     (unit tests verify nftables config; we verify the router's own pings are blocked)
#   - Rule ordering on output filter: accept rule 50 overrides drop rule 100 for real traffic
#   - Prerouting raw drop blocks incoming traffic before input chain and conntrack
#     (fires at priority raw = -300, before filter at 0; all incoming traffic hits it first)
- block:
    - name: FW-IPV4-003 - Set up eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "set interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      tags: [FW-IPV4-003, firewall, ipv4]

    - import_tasks: ../_helpers/wait_for_eth1_underlay.yml
      vars:
        _wait_test_id: "FW-IPV4-003"
      tags: [FW-IPV4-003, firewall, ipv4]

    # ── Phase A: Output filter ─────────────────────────────────────────────
    # OUTPUT hook fires for locally-originated traffic (packets generated by
    # the router itself, not forwarded). Blocking ICMP here prevents the router
    # from sending its own pings.
    - name: FW-IPV4-003 - Add output filter drop rule for ICMP
      vyos.vyos.vyos_config:
        lines:
          - "set firewall ipv4 output filter rule 100 action 'drop'"
          - "set firewall ipv4 output filter rule 100 protocol 'icmp'"
      tags: [FW-IPV4-003, firewall, ipv4]

    - name: FW-IPV4-003 - Verify locally-originated ICMP blocked by output filter
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ hostvars[rv_peer].rv_underlay_ip }} count 3 deadline 5"
      register: fw_ipv4_out_block
      tags: [FW-IPV4-003, firewall, ipv4]

    - name: FW-IPV4-003 - Assert output filter blocks router-originated ICMP
      ansible.builtin.assert:
        that:
          - fw_ipv4_out_block.stdout is defined
          - fw_ipv4_out_block.stdout | length > 0
          - "'100% packet loss' in fw_ipv4_out_block.stdout[0]"
        fail_msg: >-
          FW-IPV4-003: Expected output filter to block outgoing ICMP but ping succeeded.
          Output: {{ fw_ipv4_out_block.stdout[0] | default('(no output)') | truncate(300) }}
      tags: [FW-IPV4-003, firewall, ipv4]

    - name: FW-IPV4-003 - Add output filter accept rule (rule 50 wins over rule 100)
      vyos.vyos.vyos_config:
        lines:
          - "set firewall ipv4 output filter rule 50 action 'accept'"
          - "set firewall ipv4 output filter rule 50 protocol 'icmp'"
      tags: [FW-IPV4-003, firewall, ipv4]

    # Both routers run these tasks in parallel. r1 may add rule 50 before r2 does,
    # so r2's outgoing ICMP replies are still blocked for a few seconds after r1's
    # accept rule is in place. Retry until both sides have the accept rule active.
    - name: FW-IPV4-003 - Wait for output filter accept rule to pass ICMP (peer sync)
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ hostvars[rv_peer].rv_underlay_ip }} count 3 deadline 5"
      register: _fw_ipv4_003_output_warmup
      until: "', 0% packet loss' in _fw_ipv4_003_output_warmup.stdout[0]"
      retries: 6
      delay: 3
      tags: [FW-IPV4-003, firewall, ipv4]

    # ── Phase B: Prerouting raw ────────────────────────────────────────────
    # PREROUTING hook at priority raw (-300) fires before routing decision and
    # before conntrack. A drop rule here discards incoming traffic before the
    # input or forward chains ever see it. Distinct from input filter (priority 0).
    - name: FW-IPV4-003 - Add prerouting raw drop rule for peer ICMP
      vyos.vyos.vyos_config:
        lines:
          - "set firewall ipv4 prerouting raw rule 200 action 'drop'"
          - "set firewall ipv4 prerouting raw rule 200 protocol 'icmp'"
          - "set firewall ipv4 prerouting raw rule 200 source address '{{ hostvars[rv_peer].rv_underlay_ip }}'"
      tags: [FW-IPV4-003, firewall, ipv4]

    - name: FW-IPV4-003 - Verify peer ICMP blocked at prerouting raw
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ hostvars[rv_peer].rv_underlay_ip }} count 3 deadline 5"
      register: fw_ipv4_pre_block
      tags: [FW-IPV4-003, firewall, ipv4]

    - name: FW-IPV4-003 - Assert prerouting raw blocks incoming peer ICMP
      ansible.builtin.assert:
        that:
          - fw_ipv4_pre_block.stdout is defined
          - fw_ipv4_pre_block.stdout | length > 0
          - "'100% packet loss' in fw_ipv4_pre_block.stdout[0]"
        fail_msg: >-
          FW-IPV4-003: Expected prerouting raw to block peer ICMP but ping succeeded.
          Output: {{ fw_ipv4_pre_block.stdout[0] | default('(no output)') | truncate(300) }}
      tags: [FW-IPV4-003, firewall, ipv4]

    - name: FW-IPV4-003 - Verify output filter and prerouting raw rules configured
      vyos.vyos.vyos_command:
        commands:
          - "show configuration commands | grep 'firewall ipv4'"
      register: fw_ipv4_003_rules
      tags: [FW-IPV4-003, firewall, ipv4]

    - name: FW-IPV4-003 - Assert both hooks present in config
      ansible.builtin.assert:
        that:
          - fw_ipv4_003_rules.stdout is defined
          - fw_ipv4_003_rules.stdout | length > 0
          - "'output filter' in fw_ipv4_003_rules.stdout[0]"
          - "'prerouting raw' in fw_ipv4_003_rules.stdout[0]"
        fail_msg: >-
          FW-IPV4-003: Expected both output filter and prerouting raw rules in config.
          Got: {{ fw_ipv4_003_rules.stdout[0] | default('(no output)') | truncate(300) }}
      tags: [FW-IPV4-003, firewall, ipv4]

  rescue:
    - name: FW-IPV4-003 - Record test failure
      ansible.builtin.set_fact:
        _test_failed: true

  always:
    - name: FW-IPV4-003 - Cleanup output filter rules
      vyos.vyos.vyos_config:
        lines:
          - "delete firewall ipv4 output filter rule 50"
          - "delete firewall ipv4 output filter rule 100"
      ignore_errors: true
      tags: [FW-IPV4-003, firewall, ipv4, cleanup]

    - name: FW-IPV4-003 - Cleanup prerouting raw rule
      vyos.vyos.vyos_config:
        lines:
          - "delete firewall ipv4 prerouting raw rule 200"
      ignore_errors: true
      tags: [FW-IPV4-003, firewall, ipv4, cleanup]

    - name: FW-IPV4-003 - Remove eth1 underlay IP
      vyos.vyos.vyos_config:
        lines:
          - "delete interfaces ethernet eth1 address '{{ rv_underlay_ip }}/24'"
      ignore_errors: true
      tags: [FW-IPV4-003, firewall, ipv4, cleanup]
  when: inventory_hostname in groups['pair_1']
